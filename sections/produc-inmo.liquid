{% comment %}
  Sección: Productos (Grid / Carrusel en móvil)
{% endcomment %}

{% assign po_border_alpha = section.settings.card_border_opacity | times: 0.01 %}

<section
  class="po-products-{{ section.id }}"
  style="
    --po-max: {{ section.settings.max_width }}px;
    --po-pt: {{ section.settings.padding_top }}px;
    --po-pb: {{ section.settings.padding_bottom }}px;
    --po-gap: {{ section.settings.gap }}px;
    --po-radius: {{ section.settings.card_radius }}px;
    --po-cols-desktop: {{ section.settings.cols_desktop }};
    --po-cols-tablet: {{ section.settings.cols_tablet }};
    --po-cols-mobile: {{ section.settings.cols_mobile }};
    --po-img-ratio: {{ section.settings.image_ratio }};
  "
>
  <div class="po-container">
    {% if section.settings.heading != blank or section.settings.subheading != blank or section.settings.view_all_link != blank %}
      <header class="po-header">
        <div class="po-header-left">
          {% if section.settings.heading != blank %}
            <h2 class="po-title">{{ section.settings.heading }}</h2>
          {% endif %}
          {% if section.settings.subheading != blank %}
            <p class="po-subtitle">{{ section.settings.subheading }}</p>
          {% endif %}
        </div>

        {% if section.settings.view_all_link != blank %}
          <a class="po-viewall" href="{{ section.settings.view_all_link }}">
            {{ section.settings.view_all_text | default: 'Ver todo' }}
          </a>
        {% endif %}
      </header>
    {% endif %}

    <div class="po-wrap {% if section.settings.mobile_layout == 'carousel' %}is-carousel-mobile{% endif %}" id="po-wrap-{{ section.id }}">
      {% if section.settings.show_arrows and section.settings.mobile_layout == 'carousel' %}
        <button type="button" class="po-arrow po-prev" aria-label="Anterior">‹</button>
      {% endif %}

      <div class="po-track" id="po-track-{{ section.id }}">
        {% for block in section.blocks %}
          {% assign p = all_products[block.settings.product] %}
          {% if p %}
            <article class="po-item" {{ block.shopify_attributes }}>
              <div class="po-card">
                <a class="po-media" href="{{ p.url }}" aria-label="{{ p.title | escape }}">
                  {% if p.featured_image %}
                    <img
                      src="{{ p.featured_image | image_url: width: 900 }}"
                      alt="{{ p.featured_image.alt | default: p.title | escape }}"
                      loading="lazy"
                      width="900"
                      height="900"
                    >
                  {% else %}
                    <div class="po-media-fallback" aria-hidden="true"></div>
                  {% endif %}

                  {% if section.settings.show_badges %}
                    {% if p.compare_at_price > p.price %}
                      <span class="po-badge po-badge-sale">Oferta</span>
                    {% endif %}

                    {% if block.settings.badge_text != blank %}
                      <span class="po-badge po-badge-custom">{{ block.settings.badge_text }}</span>
                    {% endif %}
                  {% endif %}
                </a>

                <div class="po-body">
                  {% if section.settings.show_vendor and p.vendor != blank %}
                    <div class="po-vendor">{{ p.vendor }}</div>
                  {% endif %}

                  <a class="po-name" href="{{ p.url }}">
                    {{ p.title | truncate: section.settings.title_characters }}
                  </a>

                  {% if section.settings.show_price %}
                    <div class="po-price">
                      <span class="po-price-current">{{ p.price | money }}</span>
                      {% if p.compare_at_price > p.price %}
                        <span class="po-price-compare">{{ p.compare_at_price | money }}</span>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>

                {% if section.settings.show_cta %}
                  <a class="po-cta" href="{{ p.url }}">
                    {{ section.settings.cta_text | default: 'Ver producto' }}
                  </a>
                {% endif %}
              </div>
            </article>
          {% endif %}
        {% endfor %}
      </div>

      {% if section.settings.show_arrows and section.settings.mobile_layout == 'carousel' %}
        <button type="button" class="po-arrow po-next" aria-label="Siguiente">›</button>
      {% endif %}
    </div>
  </div>
</section>

<style>
  .po-products-{{ section.id }}{
    background: {{ section.settings.background }};
    padding: var(--po-pt) 0 var(--po-pb);
  }
  .po-products-{{ section.id }} .po-container{
    max-width: var(--po-max);
    margin: 0 auto;
    padding: 0 16px;
  }

  .po-products-{{ section.id }} .po-header{
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    gap: 16px;
    margin-bottom: 18px;
  }
  .po-products-{{ section.id }} .po-title{
    margin: 0;
    font-size: 28px;
    line-height: 1.15;
    color: {{ section.settings.text_color }};
  }
  .po-products-{{ section.id }} .po-subtitle{
    margin: 6px 0 0;
    color: {{ section.settings.muted_text_color }};
    font-size: 14px;
    line-height: 1.4;
  }
  .po-products-{{ section.id }} .po-viewall{
    color: {{ section.settings.link_color }};
    text-decoration: none;
    font-weight: 600;
    white-space: nowrap;
  }
  .po-products-{{ section.id }} .po-viewall:hover{ text-decoration: underline; }

  /* GRID base */
  .po-products-{{ section.id }} .po-wrap{
    position: relative;
  }
  .po-products-{{ section.id }} .po-track{
    display: grid;
    grid-template-columns: repeat(var(--po-cols-desktop), minmax(0, 1fr));
    gap: var(--po-gap);
  }

  /* Card */
  .po-products-{{ section.id }} .po-card{
    height: 100%;
    display: flex;
    flex-direction: column;
    background: {{ section.settings.card_bg }};
    border: 1px solid {{ section.settings.card_border_color | color_modify: 'alpha', po_border_alpha }};
    border-radius: var(--po-radius);
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  }

  .po-products-{{ section.id }} .po-media{
    position: relative;
    display: block;
    width: 100%;
    aspect-ratio: var(--po-img-ratio);
    background: #f3f3f3;
    overflow: hidden;
  }
  .po-products-{{ section.id }} .po-media img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform .25s ease;
  }
  .po-products-{{ section.id }} .po-card:hover .po-media img{
    transform: scale(1.03);
  }
  .po-products-{{ section.id }} .po-media-fallback{
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #eee, #f8f8f8);
  }

  .po-products-{{ section.id }} .po-badge{
    position: absolute;
    left: 10px;
    top: 10px;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    line-height: 1;
    font-weight: 700;
    color: #fff;
    background: #111;
  }
  .po-products-{{ section.id }} .po-badge-sale{ background: {{ section.settings.sale_badge_bg }}; }
  .po-products-{{ section.id }} .po-badge-custom{
    top: auto;
    bottom: 10px;
    background: {{ section.settings.custom_badge_bg }};
  }

  .po-products-{{ section.id }} .po-body{
    padding: 14px 14px 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .po-products-{{ section.id }} .po-vendor{
    font-size: 12px;
    color: {{ section.settings.muted_text_color }};
  }
  .po-products-{{ section.id }} .po-name{
    text-decoration: none;
    color: {{ section.settings.text_color }};
    font-weight: 700;
    line-height: 1.25;
    min-height: 2.5em; /* ~2 líneas */
  }
  .po-products-{{ section.id }} .po-name:hover{ text-decoration: underline; }

  .po-products-{{ section.id }} .po-price{
    display: flex;
    gap: 10px;
    align-items: baseline;
  }
  .po-products-{{ section.id }} .po-price-current{
    font-weight: 800;
    color: {{ section.settings.price_color }};
  }
  .po-products-{{ section.id }} .po-price-compare{
    color: {{ section.settings.muted_text_color }};
    text-decoration: line-through;
    font-size: 13px;
  }

  .po-products-{{ section.id }} .po-cta{
    margin-top: auto;
    display: block;
    text-align: center;
    padding: 12px 14px;
    background: {{ section.settings.cta_bg }};
    color: {{ section.settings.cta_text_color }};
    text-decoration: none;
    font-weight: 800;
    border-top: 1px solid rgba(0,0,0,0.06);
  }
  .po-products-{{ section.id }} .po-cta:hover{ filter: brightness(0.92); }

  /* Tablet */
  @media (max-width: 989px){
    .po-products-{{ section.id }} .po-track{
      grid-template-columns: repeat(var(--po-cols-tablet), minmax(0, 1fr));
    }
    .po-products-{{ section.id }} .po-title{ font-size: 24px; }
  }

  /* Mobile */
  @media (max-width: 749px){
    .po-products-{{ section.id }} .po-track{
      grid-template-columns: repeat(var(--po-cols-mobile), minmax(0, 1fr));
    }
    .po-products-{{ section.id }} .po-header{
      align-items: flex-start;
      flex-direction: column;
    }
    .po-products-{{ section.id }} .po-viewall{ margin-top: 6px; }
  }

  /* Carrusel solo en móvil (si se activa) */
  @media (max-width: 749px){
    .po-products-{{ section.id }} .po-wrap.is-carousel-mobile .po-track{
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(78%, 1fr);
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-padding: 16px;
      padding-bottom: 6px;
      -webkit-overflow-scrolling: touch;
    }
    .po-products-{{ section.id }} .po-wrap.is-carousel-mobile .po-item{
      scroll-snap-align: start;
    }
    .po-products-{{ section.id }} .po-wrap.is-carousel-mobile .po-track::-webkit-scrollbar{
      height: 8px;
    }
  }

  /* Flechas (solo si carrusel móvil) */
  .po-products-{{ section.id }} .po-arrow{
    display: none;
  }
  @media (max-width: 749px){
    .po-products-{{ section.id }} .po-wrap.is-carousel-mobile .po-arrow{
      display: inline-flex;
      position: absolute;
      top: 42%;
      transform: translateY(-50%);
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 0;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 2px 10px rgba(0,0,0,0.18);
      z-index: 5;
      font-size: 22px;
      line-height: 1;
    }
    .po-products-{{ section.id }} .po-wrap.is-carousel-mobile .po-prev{ left: 6px; }
    .po-products-{{ section.id }} .po-wrap.is-carousel-mobile .po-next{ right: 6px; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const wrap = document.getElementById('po-wrap-{{ section.id }}');
    const track = document.getElementById('po-track-{{ section.id }}');
    if (!wrap || !track) return;

    const isCarouselMobile = wrap.classList.contains('is-carousel-mobile');
    if (!isCarouselMobile) return;

    const prev = wrap.querySelector('.po-prev');
    const next = wrap.querySelector('.po-next');
    if (!prev || !next) return;

    function getStep() {
      const firstCard = track.querySelector('.po-item');
      if (!firstCard) return Math.max(240, Math.round(track.clientWidth * 0.8));
      const style = window.getComputedStyle(track);
      const gap = parseFloat(style.columnGap || style.gap || '0') || 0;
      return firstCard.getBoundingClientRect().width + gap;
    }

    prev.addEventListener('click', function() {
      track.scrollBy({ left: -getStep(), behavior: 'smooth' });
    });

    next.addEventListener('click', function() {
      track.scrollBy({ left: getStep(), behavior: 'smooth' });
    });
  });
</script>

{% schema %}
{
  "name": "Productos (Grid/Carrusel)",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "text", "id": "heading", "label": "Título", "default": "Productos destacados" },
    { "type": "textarea", "id": "subheading", "label": "Subtítulo", "default": "Selecciona productos desde bloques y se adaptará a móvil/tableta/web." },

    { "type": "url", "id": "view_all_link", "label": "Link 'Ver todo'" },
    { "type": "text", "id": "view_all_text", "label": "Texto 'Ver todo'", "default": "Ver todo" },

    {
      "type": "select",
      "id": "mobile_layout",
      "label": "Diseño en móvil",
      "default": "carousel",
      "options": [
        { "value": "grid", "label": "Grid" },
        { "value": "carousel", "label": "Carrusel (scroll horizontal)" }
      ]
    },
    { "type": "checkbox", "id": "show_arrows", "label": "Mostrar flechas en móvil (solo carrusel)", "default": true },

    { "type": "range", "id": "max_width", "min": 900, "max": 1600, "step": 50, "unit": "px", "label": "Ancho máximo", "default": 1200 },
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Padding superior", "default": 48 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Padding inferior", "default": 48 },
    { "type": "range", "id": "gap", "min": 8, "max": 32, "step": 2, "unit": "px", "label": "Separación entre tarjetas", "default": 16 },
    { "type": "range", "id": "card_radius", "min": 0, "max": 24, "step": 2, "unit": "px", "label": "Radio de tarjeta", "default": 12 },

    { "type": "range", "id": "cols_desktop", "min": 2, "max": 6, "step": 1, "label": "Columnas en desktop", "default": 4 },
    { "type": "range", "id": "cols_tablet", "min": 1, "max": 4, "step": 1, "label": "Columnas en tablet", "default": 2 },

    {
      "type": "select",
      "id": "cols_mobile",
      "label": "Columnas en móvil (si eliges grid)",
      "default": "1",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ]
    },

    {
      "type": "select",
      "id": "image_ratio",
      "label": "Aspect ratio imagen",
      "default": "1 / 1",
      "options": [
        { "value": "1 / 1", "label": "1:1 (cuadrado)" },
        { "value": "4 / 3", "label": "4:3" },
        { "value": "3 / 4", "label": "3:4" },
        { "value": "16 / 9", "label": "16:9" }
      ]
    },

    { "type": "checkbox", "id": "show_vendor", "label": "Mostrar marca (vendor)", "default": false },
    { "type": "checkbox", "id": "show_price", "label": "Mostrar precio", "default": true },
    { "type": "checkbox", "id": "show_cta", "label": "Mostrar botón CTA", "default": true },
    { "type": "text", "id": "cta_text", "label": "Texto CTA", "default": "Ver producto" },

    { "type": "range", "id": "title_characters", "min": 20, "max": 80, "step": 1, "label": "Caracteres máximo título", "default": 40 },

    { "type": "checkbox", "id": "show_badges", "label": "Mostrar badges", "default": true },

    { "type": "color", "id": "background", "label": "Fondo sección", "default": "#ffffff" },
    { "type": "color", "id": "text_color", "label": "Texto principal", "default": "#111111" },
    { "type": "color", "id": "muted_text_color", "label": "Texto secundario", "default": "#666666" },
    { "type": "color", "id": "link_color", "label": "Color link", "default": "#111111" },

    { "type": "color", "id": "card_bg", "label": "Fondo tarjeta", "default": "#ffffff" },
    { "type": "color", "id": "card_border_color", "label": "Color borde tarjeta", "default": "#000000" },
    { "type": "range", "id": "card_border_opacity", "min": 0, "max": 30, "step": 1, "unit": "%", "label": "Opacidad borde (0-30%)", "default": 8 },

    { "type": "color", "id": "price_color", "label": "Color precio", "default": "#111111" },

    { "type": "color", "id": "cta_bg", "label": "Fondo CTA", "default": "#111111" },
    { "type": "color", "id": "cta_text_color", "label": "Texto CTA", "default": "#ffffff" },

    { "type": "color", "id": "sale_badge_bg", "label": "Badge oferta", "default": "#e11d48" },
    { "type": "color", "id": "custom_badge_bg", "label": "Badge personalizado", "default": "#2563eb" }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Producto",
      "settings": [
        { "type": "product", "id": "product", "label": "Seleccionar producto" },
        { "type": "text", "id": "badge_text", "label": "Badge (opcional)" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Productos (Grid/Carrusel)",
      "blocks": [
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" }
      ]
    }
  ]
}
{% endschema %}


